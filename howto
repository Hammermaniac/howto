#!/bin/bash

# Exit if no arguments are supplied, nothing to do.
if [ $# -eq 0 ] ; then
        displayhelp
        exit 1
fi

# Declare book name in ${books} array, e.g. books=( "mybook" "git" )
# Then create a file in ~/.common-configs/ using the naming convention: howto.mybook
#
# So the above should be:
#   ~/.common-configs/howto.mybook
#   ~/.common-configs/howto.git

## Books ##
books=( "void" "term" )

# VARIABLES
n=$#
numbooks=${#books[@]}
onlybook=false
allbooks=false
legacy=false

# FUNCTIONS
displayhelp() {
	echo
	echo "Usage: howto [OPTION]... [STRING1] [STRING2]..."
	echo "Or:    howto [OPTION]... [BOOK_NAME] [STRING1]..."
	echo
	echo "Options:"
	echo
	echo "  -h, --help       Display this help text."
	echo "  -n, --nocolor    Don't use colors with output."
	echo "  -b, --books      Display all book names configured in the script."
	echo "  -o, --onlybook   Only search in the specified book."
	echo "  -a, --allbooks   Search all books simultaneously."
	echo
        echo "Specifying a book name as an argument will search for the given string in the specified book."
        echo "Example, assume book name is 'mybook':"
        echo "howto mybook 'git config'"
	echo
	echo "TIP: Specify a ':' as the search string to print all entries of any book."
	echo
}

readbook() {
	echo
	for n do {
                # Escape if we run out of arguments.
                if [ $# -eq 0 ] ; then
                        exit 0
                fi
		# Find supplied argument (keyword) in book and display.
                grep -i "$1" "$book" | while read -r line
                do
                        if [ "$1" == '' ] ; then
                                break
                        fi
                        echo -e "\033[36m——————————————————————————————————\033[0m"
                        line=$(printf '%b\n' "$( echo -e "$line" | sed ''/": "/s//:`printf "\033[1;36m——————————————————————————————————\033[0m"`/'' | sed 's/——————————————————————————————————/\n——————————————————————————————————\n/' )")
                        echo -e "$line\n\n"
                done
                shift
	} done
}

checkargs() {
	# Check if we have remaining arguments to use as search strings in readbook().
	if [ $# -eq 0 ] ; then
		echo -e "Error: No arguments supplied after book."
                displayhelp
                exit 1
	fi
}

usebook() {
#	if [ "$allbooks" == true ] ; then
#	fi

	if [[ "${books[@]}" =~ "$1" ]] ; then
		book="/home/$USER/.common-configs/howto.$1"
		shift
		checkargs
		readbook "$@"
	else
		if test -f $book ; then
			echo "File '$book' exists, but isn't configured in the 'books' array."
			echo "Please add it in order for the --allbooks feature to work."
			book="/home/$USER/.common-configs/howto.$1"
			shift
			checkargs
			readbook "$@"
		else
			
		fi
	fi
}

displaybooks() {
	echo
	echo "${books[@]}"
       	echo
}

runlegacy() {
	for n do {
		# Escape if we run out of arguments.
		if [ $# -eq 0 ] ; then
			exit 0
		fi
		# If argument is a book title (i.e in ${books} array), use the specified book.
		if [[ "${books[@]}" =~ "$1" ]]
		then
			book="/home/$USER/.common-configs/howto.$1"
			shift
			if [ $# -eq 0 ] ; then
				echo -e "Error: No arguments supplied after book."
				displayhelp
				exit 1
			fi
		else
			book="/home/$USER/.common-configs/howto.main"
		fi
		echo
		# Find supplied argument (keyword) in book and display.
		grep -i "$1" "$book" | while read -r line
		do
			if [ "$1" == '' ] ; then
				break
			fi
			echo -e "\033[36m——————————————————————————————————\033[0m"
			line=$(printf '%b\n' "$( echo -e "$line" | sed ''/": "/s//:`printf "\033[1;36m——————————————————————————————————\033[0m"`/'' | sed 's/——————————————————————————————————/\n——————————————————————————————————\n/' )")
			echo -e "$line\n\n"
		done
		shift
	} done
}

while [ ! "$#" -eq 0 ]
do
	case "$1" in
		-h|--help) # Display the help text.
			displayhelp # Call the displayhelp function.
			exit 0
			;;
		-n|--nocolor) # Don't use colors with script output.
			nocolor # Call the nocolor function.
			shift
			;;
		-b|--books) # Display all book names.
			displaybooks
			exit 0
			;;
		-o|--onlybook) # Only search in specific book.
			shift
			book="/home/$USER/.common-configs/howto.$1"
			onlybook=true
			shift
			readbook "$@"
			exit 0
			;;
		-a|--allbooks) # Search all books simultaneously for provided string.
			allbooks=true
			shift
			usebook "$@"
			exit 0
			;;
		--)
			break
			;;
		-*)
			echo "Invalid option: '$1'"
			echo "Try '$0 --help' for more information."
			exit 1
			;;
		*)
			# runlegacy "$@"
			legacy=true
			usebook "$@"
			exit 0
			;;
	esac
done
